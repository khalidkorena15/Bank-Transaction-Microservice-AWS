#!/bin/bash
# =========================================================
# ðŸ” REQUIRED AWS CONFIG (VERY IMPORTANT)
#
# This script must be run on a PUBLIC EC2 acting as
# a NAT INSTANCE.
#
# AWS REQUIREMENTS:
# 1ï¸âƒ£ EC2 Source/Destination Check MUST be DISABLED
#    EC2 â†’ Networking â†’ Change source/destination check
#
# 2ï¸âƒ£ Security Group (Public EC2)
#    - Allow ALL traffic from private subnet CIDR
#    - Allow SSH only from trusted IPs
#
# 3ï¸âƒ£ Route Table (Private Subnet)
#    - 0.0.0.0/0 â†’ Target: NAT Instance (this EC2)
#
# Without these AWS settings, this script will NOT work.
# =========================================================
#
# Script Purpose:
# Configure iptables NAT rules to allow outbound
# internet access for private EC2 instances.
#
# Author: Khalid Korena
# Project: Bank Transaction Microservice â€“ Secure AWS Architecture
# =========================================================

set -e

echo "ðŸš€ Configuring NAT Instance iptables..."

# Enable IP forwarding (temporary)
sudo sysctl -w net.ipv4.ip_forward=1

# Enable IP forwarding (persistent)
if grep -q "^#net.ipv4.ip_forward=1" /etc/sysctl.conf; then
    sudo sed -i 's/^#net.ipv4.ip_forward=1/net.ipv4.ip_forward=1/' /etc/sysctl.conf
elif ! grep -q "^net.ipv4.ip_forward=1" /etc/sysctl.conf; then
    echo "net.ipv4.ip_forward=1" | sudo tee -a /etc/sysctl.conf
fi

echo "âœ… IP forwarding enabled."

# Flush existing rules (safe for fresh NAT instance)
sudo iptables -F
sudo iptables -t nat -F
sudo iptables -X

# NAT masquerading (replace ens5 if interface differs)
sudo iptables -t nat -A POSTROUTING -o ens5 -j MASQUERADE

# Allow forwarding traffic
sudo iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
sudo iptables -A FORWARD -j ACCEPT

echo "âœ… iptables NAT rules applied."

# Save rules (Amazon Linux vs Ubuntu)
if command -v iptables-save >/dev/null 2>&1; then
    sudo iptables-save | sudo tee /etc/iptables.rules
fi

echo "ðŸŽ‰ NAT Instance configuration completed successfully."
echo "Private EC2 instances can now access the internet."
